name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

jobs:
  test:
    name: Test PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.0', '8.1', '8.2', '8.3']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: curl, xml, mbstring, zip, pdo, sqlite, redis
        coverage: xdebug
        tools: composer:v2
        
    - name: Validate composer.json
      run: composer validate --strict
      
    - name: Cache Composer packages
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-${{ matrix.php-version }}-
          
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-interaction
      
    - name: Run tests
      run: composer test
      
    - name: Run code style check
      run: composer lint
      
    - name: Generate coverage report
      if: matrix.php-version == '8.2'
      run: composer test-coverage
      
    - name: Upload coverage to Codecov
      if: matrix.php-version == '8.2'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        extensions: curl, xml, mbstring, zip
        tools: composer:v2
        
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress
      
    - name: Run PHPStan
      run: composer analyze
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        tools: composer:v2
        
    - name: Check for security vulnerabilities
      run: |
        composer require --dev enlightn/security-checker
        vendor/bin/security-checker security:check composer.lock
      continue-on-error: true

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          iprodev/PHP-XML-Sitemap-Generator:latest
          iprodev/PHP-XML-Sitemap-Generator:${{ github.sha }}
        cache-from: type=registry,ref=iprodev/PHP-XML-Sitemap-Generator:buildcache
        cache-to: type=registry,ref=iprodev/PHP-XML-Sitemap-Generator:buildcache,mode=max

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, static-analysis, build-docker]
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2
        tools: composer:v2
        
    - name: Install dependencies
      run: composer install --no-dev --optimize-autoloader
      
    - name: Create release archive
      run: |
        zip -r PHP-XML-Sitemap-Generator-${{ github.event.release.tag_name }}.zip . \
          -x "*.git*" "tests/*" "*.github/*" "docker-compose.yml"
        
    - name: Upload release asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./PHP-XML-Sitemap-Generator-${{ github.event.release.tag_name }}.zip
        asset_name: PHP-XML-Sitemap-Generator-${{ github.event.release.tag_name }}.zip
        asset_content_type: application/zip
